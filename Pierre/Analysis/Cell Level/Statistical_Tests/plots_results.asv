% Script to generate the main plots of the cell analysis
clear

data = load("dataRegression.mat");
data = data.data;
set(0,'defaultfigurecolor',[1 1 1])

session = data_folders_excl;
session = session{6};

load(session + "/extracted_place_fields.mat")
load(session + "\extracted_lap_place_fields.mat")

%% I. Stacked plot of sorted place field ----------------------------------

%% a. Remapping Track 1 vs. Track 2

goodCells = intersect(place_fields.track(3).good_cells, place_fields.track(4).good_cells);

pf_track1 = cell2mat(place_fields.track(3).smooth');
pf_track1 = pf_track1(goodCells, :);
pf_track2 = cell2mat(place_fields.track(4).smooth');
pf_track2 = pf_track2(goodCells, :);

pf_track1 = normalize(pf_track1, 2, "range");
pf_track2 = normalize(pf_track2, 2, "range");

sortOrderT1 = findSortOrder(pf_track1);
sortOrderT2 = findSortOrder(pf_track2);

pfT1ST1 = pf_track1(sortOrderT1, :);
pfT2ST1 = pf_track2(sortOrderT1, :);
pfT1ST2 = pf_track1(sortOrderT2, :);
pfT2ST2 = pf_track2(sortOrderT2, :);

fig = figure;
fig.Position = [680,421,682,457];
t = tiledlayout(2, 2);
set(gca,'fontname','times')  % Set it to times

nexttile;
stackPF(pfT1ST1, "Place fields on Track 1", "Cells (sorted by Track 1)");
nexttile;
stackPF(pfT1ST2, "Place fields on Track 1", "Cells (sorted by Track 2)");
nexttile;
stackPF(pfT2ST1, "Place fields on Track 2", "Cells (sorted by Track 1)");
nexttile;
stackPF(pfT2ST2, "Place fields on Track 2", "Cells (sorted by Track 2)");

%% b. Remapping first vs. last lap RUN1, ordered by Final Place Field

goodCells = lap_place_fields(1).Complete_Lap{end}.good_cells;

pf_trackLap1 = cell2mat(lap_place_fields(1).Complete_Lap{1}.smooth');
pf_trackLap1 = pf_trackLap1(goodCells, :);

pf_trackLap2 = cell2mat(lap_place_fields(1).Complete_Lap{2}.smooth');
pf_trackLap2 = pf_trackLap2(goodCells, :);

pf_trackLap3 = cell2mat(lap_place_fields(1).Complete_Lap{3}.smooth');
pf_trackLap3 = pf_trackLap3(goodCells, :);

pf_trackLapEnd = cell2mat(lap_place_fields(1).Complete_Lap{end}.smooth');
pf_trackLapEnd = pf_trackLapEnd(goodCells, :);

% We get the final place field
allLapsRUN2 = lap_place_fields(3).Complete_Lap;
meanMat = zeros(numel(goodCells), 100, 6);

for lap = 1:6
    data = cell2mat(allLapsRUN2{16 + lap}.smooth');
    data = data(goodCells, :);
    meanMat(:, :, lap) = data;
end

meanMat = normalize(mean(meanMat, 3, 'omitnan'), 2, "range");

pf_trackLap1 = normalize(pf_trackLap1, 2, "range");
pf_trackLap2 = normalize(pf_trackLap2, 2, "range");
pf_trackLap3 = normalize(pf_trackLap3, 2, "range");
pf_trackLapEnd = normalize(pf_trackLapEnd, 2, "range");

sortOrder = findSortOrder(meanMat);

fig2 = figure;
fig2.Position = [200, 200, 1400,300];
t2 = tiledlayout(1, 4);
set(gca,'fontname','times')  % Set it to times

set(gcf,'color','w');
nexttile;
stackPF(pf_trackLap1(sortOrder, :), "Place fields - Lap 1", "");
mylabel = ylabel({"Cells          ", "(sorted by FPF)"}, "Rotation", 0, "FontSize", 13);

nexttile;
stackPF(pf_trackLap2(sortOrder, :), "Place fields - Lap 2", "");
nexttile;
stackPF(pf_trackLap3(sortOrder, :), "Place fields - Lap 3", "");
nexttile;
stackPF(pf_trackLapEnd(sortOrder, :), "Place fields - Lap 16", "");

%% c. Remapping last lap before sleep - first lap after sleep

goodCells = lap_place_fields(4).Complete_Lap{1}.good_cells;

pf_trackEXP = cell2mat(lap_place_fields(2).Complete_Lap{end}.smooth');
pf_trackEXP = pf_trackEXP(goodCells, :);
pf_trackREEXP = cell2mat(lap_place_fields(4).Complete_Lap{1}.smooth');
pf_trackREEXP = pf_trackREEXP(goodCells, :);

% We get the final place field
allLapsRUN2 = lap_place_fields(4).Complete_Lap;
meanMat = zeros(numel(goodCells), 100, 6);

for lap = 1:6
    data = cell2mat(allLapsRUN2{16 + lap}.smooth');
    data = data(goodCells, :);
    meanMat(:, :, lap) = data;
end

meanMat = normalize(mean(meanMat, 3, 'omitnan'), 2, "range");

pf_trackEXP = normalize(pf_trackEXP, 2, "range");
pf_trackREEXP = normalize(pf_trackREEXP, 2, "range");

sortOrder = findSortOrder(meanMat);

fig2 = figure;
fig2.Position = [500, 500, 830,290];
t2 = tiledlayout(1, 2);
set(gca,'fontname','times')  % Set it to times

set(gcf,'color','w');
nexttile;
stackPF(pf_trackEXP(sortOrder, :), "Place fields - Lap before sleep", "");

mylabel = ylabel({"Cells        ", "(sorted by FPF)"}, "Rotation", 0, "FontSize", 13);

nexttile;
stackPF(pf_trackREEXP(sortOrder, :), "Place fields - Lap after sleep", "");


%% II. Remapping over laps -----------------------------------


x = linspace(-5, 5, 100);
y1 = normpdf(x, 0, 1.2);
y2 = 0.3 *normpdf(x, 0, 1.2);

figure;
hold on;
area(x, y1, 'FaceColor', '#4789bb', 'EdgeColor', 'none');
area(x, y2, 'FaceColor', '#e15e4e', 'EdgeColor', 'none');
hold off;
axis off;
axis square;

%% a. Population change

% 1. PV - Correlation with the final place field

dataLapCorr = load("../../Population Level/Statistics/timeSeries.mat");
dataLapCorr = dataLapCorr.data;
summaryLapDataCorr = groupsummary(dataLapCorr, ["condition", "exposure", "lap"], ["median", "std"], ["pvCorr"]);
summaryLapDataCorr.se_pvCorr = summaryLapDataCorr.std_pvCorr./sqrt(summaryLapDataCorr.GroupCount);

f4_5 = figure; 
f4_5.Position = [0,0,964,542];
timeSeriesOverLapPop(summaryLapDataCorr, "median_pvCorr", "se_pvCorr", "PV correlation with the FPF");


% 2. PV- Correlation between one direction and the other (directionality)

dataLapCorr = load("../../Population Level/Statistics/timeSeriesDirectionnality.mat");
dataLapCorr = dataLapCorr.data;
summaryLapDataCorr = groupsummary(dataLapCorr, ["condition", "exposure", "lap"], ["median", "std"], ["pvCorr"]);
summaryLapDataCorr.se_pvCorr = summaryLapDataCorr.std_pvCorr./sqrt(summaryLapDataCorr.GroupCount);

f4_7 = figure; 
f4_7.Position = [0,0,964,542];
timeSeriesOverLapPop(summaryLapDataCorr, "median_pvCorr", "se_pvCorr", "PV correlation between opposite direction PF");

%% b. Cell change --------------------------------------------------------

dataLap = load("timeSeries.mat");
dataLap = dataLap.data;
summaryLapData = groupsummary(dataLap, ["condition", "exposure", "lap"], ["median", "std"], ["CMdiff", "FRdiff", "PeakDiff"]);
summaryLapData.se_CMdiff = summaryLapData.std_CMdiff./sqrt(summaryLapData.GroupCount);
summaryLapData.se_FRdiff = summaryLapData.std_FRdiff./sqrt(summaryLapData.GroupCount);
summaryLapData.se_PeakDiff = summaryLapData.std_PeakDiff./sqrt(summaryLapData.GroupCount);


% 1. Center of mass
f5 = figure; 
f5.Position = [0,0,964,542];
timeSeriesOverLap(summaryLapData, "median_CMdiff", "se_CMdiff", "Center of Mass");

% 2. Peak Location

f6 = figure; 
f6.Position = [0, 0, 964, 542];
timeSeriesOverLap(summaryLapData, "median_FRdiff", "se_FRdiff", "Max Firing Rate");

% 3. Max firing rate

f7 = figure; 
f7.Position = [0, 0, 964, 542];
timeSeriesOverLap(summaryLapData, "median_PeakDiff", "se_PeakDiff", "Peak Location");


%% c. Cell change - 1 vs 16 vs 1 vs 16 vs FPF

summaryLapDataAnim = groupsummary(dataLap, ["animal", "condition", "exposure", "lap"], ["mean", "std"], ["CMdiff", "FRdiff", "PeakDiff"]);

f8 = figure;
f8.Position = [0,0,900,420];

dataExpLap1 = summaryLapDataAnim(summaryLapDataAnim.lap == 1 & summaryLapDataAnim.exposure == 1, :);
dataReExpLap1 = summaryLapDataAnim(summaryLapDataAnim.lap == 1 & summaryLapDataAnim.exposure == 2, :);
dataExpLapEnd = summaryLapDataAnim(summaryLapDataAnim.lap == summaryLapDataAnim.condition & summaryLapDataAnim.exposure == 1, :);
dataReExpLapEnd = summaryLapDataAnim(summaryLapDataAnim.lap == 16 & summaryLapDataAnim.exposure == 2, :);
conditionCat = categorical(dataExpLap1.condition);

t8 = tiledlayout(1, 4);
colors = [255, 215, 0;
              255, 168, 0;
              255, 98, 82;
              205, 52, 181;
              157, 2, 215;
              0, 0, 255];

% Normalize the RGB values to be between 0 and 1
colors = colors / 255;
colors = flip(colors);

n1 = nexttile(1);
b1 = boxplot(dataExpLap1.mean_CMdiff, conditionCat);
title('1^{st} lap - RUN1')
ylim([0 60])

h = findobj(n1, 'Tag','Box');
for j=1:length(h)
    patch(get(h(j),'XData'),get(h(j),'YData'), colors(j, :),'FaceAlpha',.5);
end

n2 = nexttile(2);
b2 = boxplot(dataExpLapEnd.mean_CMdiff, conditionCat);
title('Last lap - RUN1')
ylim([0 60])

h = findobj(n2, 'Tag','Box');
for j=1:length(h)
    patch(get(h(j),'XData'),get(h(j),'YData'), colors(j, :),'FaceAlpha',.5);
end

n3 = nexttile(3);
b3 = boxplot(dataReExpLap1.mean_CMdiff, conditionCat);
title('1^{st} lap - RUN2')
ylim([0 60])

h = findobj(n3, 'Tag','Box');
for j=1:length(h)
    patch(get(h(j),'XData'),get(h(j),'YData'), colors(j, :),'FaceAlpha',.5);
end

n4 = nexttile(4);
b4 = boxplot(dataReExpLapEnd.mean_CMdiff, conditionCat);
title('16^{th} lap - RUN1')
ylim([0 60])

h = findobj(n4, 'Tag','Box');
for j=1:length(h)
    patch(get(h(j),'XData'),get(h(j),'YData'), colors(j, :),'FaceAlpha',.5);
end

n1.FontSize = 12;
n2.FontSize = 12;
n3.FontSize = 12;
n4.FontSize = 12;

xlabel(t8, "Condition", 'FontSize', 12)
ylabel(t8, "\DeltaCM with the FPF", 'FontSize', 12)

%% III. Replay plots -----------------------------------------------------

% 1. Replay decoding

load(session + "\Replay\RUN1_decoding\significant_replay_events_wcorr");
minPIndex = find(significant_replay_events.track(1).p_value == min(significant_replay_events.track(1).p_value));
minPIndex = minPIndex(4);
dec_position = significant_replay_events.track(1).decoded_position{minPIndex};
time_size = numel(dec_position(1, :));

% We get a raster plot of all the activity
allSpikes = significant_replay_events.track(1).spikes{minPIndex};

f = figure;

tiledlayout(1, 2);
t10 = nexttile;
makeRaster(allSpikes, time_size)
title("Spike count")

t11 = nexttile;
imagesc(dec_position);
axis on;
xticks(0:2:time_size);
xticklabels(0:0.040:(time_size*0.020))
xlabel("Time (s)");
ylabel("Position (cm)")
yticks([0.5, 10.5, 20.5]);
yticklabels([200, 100, 0])
title("Bayesian reconstruction")
colorbar;

%% Explaining Final Place Field and PV-correlation

%% Final place field

% 6 x 1 subplots of place fields during consecutive laps
f = figure;
cellChosen = goodCells(11);
xChosen = 25:27;
fpf = zeros(1, 100);

f.Position = [680   122   560   756];

for i = 1:6
    pf_trackLap = cell2mat(lap_place_fields(3).Complete_Lap{16 + i}.smooth');
    pf_trackLap = pf_trackLap(cellChosen, :);
    fpf = fpf + pf_trackLap;
    
    subplot(8, 1, i)
    area(pf_trackLap, "EdgeColor", "none", "FaceColor", '#4789bb');
    hold on;
    area(xChosen, pf_trackLap(xChosen), "EdgeColor", "none", "FaceColor", '#e15e4e');
    axis off

end

fpf = fpf/6;

subplot(8, 1, 8);
area(fpf, "EdgeColor", "none", "FaceColor", '#4789bb');
hold on;
area(xChosen, fpf(xChosen), "EdgeColor", "none", "FaceColor", '#e15e4e');

h=gca; 
h.Box = "off";
h.XAxis.TickLength = [0 0];
h.YAxis.TickLength = [0 0];
ylabel("FR")
xlabel("Position (cm)")

%% PV correlation

f = figure;
f.Position = [680   122   560   756];

cellsChosen = [16 60 61 31];
cellsChosen = goodCells(cellsChosen);
xChosen = 50:54;

cellsPFLap1 = cell2mat(lap_place_fields(1).Complete_Lap{6}.smooth');
cellsPFLap1 = cellsPFLap1(cellsChosen, :);

cellsFPF = zeros(size(cellsPFLap1));

for cellID = 1:numel(cellsChosen)
    current_cell = cellsChosen(cellID);
    fpf = zeros(1, 100);

    for i = 1:6
        current_pf = lap_place_fields(3).Complete_Lap{16 + i}.smooth{current_cell};
        fpf = fpf + current_pf;
    end
    cellsFPF(cellID, :) = fpf/6;
end

ylimLap1 = max(max(cellsPFLap1));
ylimFPF =  max(max(cellsFPF));

current_ylim = max([ylimLap1, ylimFPF]);

for cellID = 1:numel(cellsChosen)

    current_cell = cellsChosen(cellID);
    subplot(numel(cellsChosen) + 1, 2, 2*cellID - 1)
    area(cellsPFLap1(cellID, :), "EdgeColor", "none", "FaceColor", '#4789bb')
    ylim([0 current_ylim]);
    hold on;
    area(xChosen, cellsPFLap1(cellID, xChosen), "EdgeColor", "none", "FaceColor", '#e15e4e');
    axis off;

    subplot(numel(cellsChosen) + 1, 2, 2*cellID)
    area(cellsFPF(cellID, :), "EdgeColor", "none", "FaceColor", '#4789bb')
    ylim([0 current_ylim]);
    hold on;
    area(xChosen, cellsFPF(cellID, xChosen), "EdgeColor", "none", "FaceColor", '#e15e4e');
    axis off;

    subplot(numel(cellsChosen) + 1, 2, 2*numel(cellsChosen) + 1)
    area(xChosen - 22 + cellID * 10, cellsPFLap1(cellID, xChosen), "EdgeColor", "none", "FaceColor", '#e15e4e');
    hold on;
    axis off;
    xlim([0 100]);
    ylim([0 current_ylim]);

    subplot(numel(cellsChosen) + 1, 2, 2*numel(cellsChosen) + 2)
    area(xChosen - 22 + cellID * 10, cellsFPF(cellID, xChosen), "EdgeColor", "none", "FaceColor", '#e15e4e');
    hold on;
    axis off;
    xlim([0 100]);
    ylim([0 current_ylim]);

end

%% Suplementary stuff

% Look at firing rate for dis / app / stable

dataLap = load("timeSeries.mat");
dataLap = dataLap.data;
summaryLapData = groupsummary(dataLap, ["condition", "exposure", "lap", "label"], ["median", "std"], ["CMdiff", "FRdiff", "PeakDiff", "meanFR"]);

timeSeriesOverLap(summaryLapData, "median_CMdiff", "se_CMdiff", "Center of Mass");


